SELECT
	m_app_id AS BotID, 
	t_name AS WorkspaceName,
	a_name AS APPName,
	SUM(date_token_count) AS token_count, 
	SUM(date_total_price) AS total_price, 
	SUM(date_message_count) AS message_count, 
	SUM(date_active_user_count) AS terminal_count
FROM (SELECT
		m.app_id AS m_app_id, 
		t.name AS t_name, 
		a.name AS a_name, 
		(SUM(m.message_tokens) + SUM(m.answer_tokens)) AS date_token_count,
		SUM(m.total_price) AS date_total_price,
		COUNT(*) AS date_message_count,
		DATE(DATE_TRUNC('day', m.created_at AT TIME ZONE 'UTC' AT TIME ZONE 'Asia/Shanghai')) AS msg_date, 
		COUNT(DISTINCT m.from_end_user_id) AS date_active_user_count
	FROM
		messages m
	JOIN 
		apps a
	ON 
		m.app_id = a.id
	JOIN 
		tenants t 
	ON 
		a.tenant_id = t.id
	WHERE
		a.name ilike '%{{Table1.searchText}}%'
	GROUP BY
		t.name,m.app_id, a.name, msg_date
	ORDER BY
		msg_date)
GROUP BY
	t_name,m_app_id, a_name
ORDER BY     
	"{{Table1.sortOrder.column || 'token_count'}}" {{Table1.sortOrder.order !== "desc" ? "" : "DESC"}}
LIMIT
  {{Table1.pageSize}}
OFFSET
  {{Table1.pageOffset}}		