SELECT
	m.app_id,
	a.name AS appName,
	a.mode AS appMode, 
	t.name AS WorkspaceName,
	(SUM(m.message_tokens) + SUM(m.answer_tokens)) AS token_count
FROM
	messages m
JOIN
	apps a
ON
	m.app_id = a.id
JOIN
	tenants t 
ON
	a.tenant_id = t.id
GROUP BY
	t.name, m.app_id, a.name, a.mode
UNION
SELECT 
	wr.app_id, 
	a.name AS appName, 
	a.mode AS appMode, 
	t.name AS WorkspaceName, 
	SUM(wr.total_tokens) AS token_count
FROM 
	workflow_runs wr 
JOIN 
	apps a
ON 
	wr.app_id = a.id
JOIN 
	tenants t 
ON 
	a.tenant_id = t.id
WHERE 
	a.mode = 'workflow'
	AND wr.triggered_from = 'app-run'
GROUP BY
	t.name, wr.app_id, a.name, a.mode
ORDER BY
	token_count DESC
LIMIT 20;	
